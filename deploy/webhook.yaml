---
apiVersion: v1
kind: Service
metadata:
  name: mutateme
  labels:
    app: mutateme
spec:
  publishNotReadyAddresses: true
  ports:
    - port: 443
      targetPort: 8443
  selector:
    app: mutateme

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mutateme
  labels:
    app: mutateme
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mutateme
  template:
    metadata:
      name: mutateme
      labels:
        app: mutateme
    spec:
      serviceAccountName: kubesecman
      containers:
        - name: mutator
          image: 3236527/k8s-mutate-webhook:latest
          imagePullPolicy: Always
          resources:
            limits:
              cpu: 500m
              memory: 128Mi
            requests:
              cpu: 250m
              memory: 64Mi

---
apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingWebhookConfiguration
metadata:
  name: mutateme
  labels:
    app: mutateme
webhooks:
  - name: mutateme.default.svc.cluster.local
    clientConfig:
      caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURDekNDQWZPZ0F3SUJBZ0lRYWhVc09udllIbnFhU0N6ZmxrYkdJREFOQmdrcWhraUc5dzBCQVFzRkFEQXYKTVMwd0t3WURWUVFERXlSaU4yWTJaR1poWVMxa01qRXpMVFJtTUdNdFlqWXpOUzB6T0RsaE16TTRNR0U0TjJNdwpIaGNOTWpBd016RTBNRFl5TnpVM1doY05NalV3TXpFek1EY3lOelUzV2pBdk1TMHdLd1lEVlFRREV5UmlOMlkyClpHWmhZUzFrTWpFekxUUm1NR010WWpZek5TMHpPRGxoTXpNNE1HRTROMk13Z2dFaU1BMEdDU3FHU0liM0RRRUIKQVFVQUE0SUJEd0F3Z2dFS0FvSUJBUUN0S1lqOU1yZWJic0h5U2N4ZXZYelVPZWUvUElJTlhDcng5RWM3RmZ1dwpybjR2endBdDBFT25RWjdHZXAxRTVjY2FQS2YrSENhTGw0Q0NDTXJkd1RkSU50OGdZVXpHTys1NlR5QnpkM2twCkkyV3JLRmF5b0pGSE5Ja3ZvN2xHazQ4ZEJ2WWM1TlFEL0kwOEM2ei92ZURpMHNBL003dDB6MndxRkQ1djh0RnMKRHo5S3YwOTNxWXFDSEtsN3haeHV5SjIzcENtR2ViaGlmd3hOVjI5b1JtNVNXUEsyRU51UVM3RVFLcjVCdmVMQgpsT29pMGszMjVmNkFHM2R1YlpQSkRXWG8yY3E0cU45Y2pXbHliOVk1T2lTNjRsTS90akVjdHVQN2N1a1pOYTQzClZtQUZhUzF0dHZZQW9ndkU1akMzVFd0U1QxWUhlWkNLRjJ2SzhLOEdSVDZUQWdNQkFBR2pJekFoTUE0R0ExVWQKRHdFQi93UUVBd0lDQkRBUEJnTlZIUk1CQWY4RUJUQURBUUgvTUEwR0NTcUdTSWIzRFFFQkN3VUFBNElCQVFBcApBdHpSR2wvUzZDMjZLeGRaRFhhOXBQV3JXeVV6MFVvSnlpWFZFRlErMzJDaThEZW0yNDRkbkpZSE5yR2E0Zzd6CitYK3JRNDR5ZnkrL2JJTlRVaFNycjJ0NTdtbFIrUFY5aURCZUc1cVIvbEduTmtOMWQ2QStuWXJMOUVzYzBVYncKcm5YTG51b1JOVUNtVkhXM1lpYVdQcW9uRXNiYXZqYk9ZWXAzKy9MVUZoUWtHcENIY1hKdlR2a3RidTBTM0JaZwpvZzRwVGpCYmV2OXFFRHlYWWl5N0lOQndRNmhDZS9tTmdWQUxZRTBES2Z1VERBN1dTRnhHL2puRGprQmFheGlMCnQ1ZisydTNWMG5JN3Bkck9DODRLQUZzK3pYUDRuc1NFSTZyRlJQT2FOSVhkUENpWm92UUhScFovTEtORjlQTEQKL0JWaFE3VzZEc3JNdkhLSUlvVGsKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
      service:
        name: mutateme
        namespace: default
        path: "/mutate"
    rules:
      - operations: ["CREATE"]
        apiGroups: [""]
        apiVersions: ["v1"]
        resources: ["secrets"]
      - operations: ["UPDATE"]
        apiGroups: [""]
        apiVersions: ["v1"]
        resources: ["secrets"]
    namespaceSelector:
      matchLabels:
        mutateme: enabled
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: kubesecman
  namespace: default