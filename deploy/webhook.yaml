---
apiVersion: v1
kind: Service
metadata:
  name: mutateme
  labels:
    app: mutateme
spec:
  publishNotReadyAddresses: true
  ports:
    - port: 443
      targetPort: 8443
  selector:
    app: mutateme

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mutateme
  labels:
    app: mutateme
spec:
  replicas: 3
  selector:
    matchLabels:
      app: mutateme
  template:
    metadata:
      name: mutateme
      labels:
        app: mutateme
    spec:
      serviceAccountName: kubesecman
      containers:
        - name: mutator
          image: 3236527/k8s-mutate-webhook:latest
          imagePullPolicy: Always
          resources:
            limits:
              cpu: 500m
              memory: 128Mi
            requests:
              cpu: 250m
              memory: 64Mi

---
apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingWebhookConfiguration
metadata:
  name: mutateme
  labels:
    app: mutateme
webhooks:
  - name: mutateme.default.svc.cluster.local
    clientConfig:
      caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURERENDQWZTZ0F3SUJBZ0lSQUlVcnFkMWNnbGxQTUZVWXZWMFhoNEl3RFFZSktvWklodmNOQVFFTEJRQXcKTHpFdE1Dc0dBMVVFQXhNa04yWTBNVFppTWpFdE5URTNNeTAwT0RBMExUZzFaVGd0TW1VNFlqa3pObVEyTm1ZdwpNQjRYRFRJd01ETXhOVEEyTXpRd05Wb1hEVEkxTURNeE5EQTNNelF3TlZvd0x6RXRNQ3NHQTFVRUF4TWtOMlkwCk1UWmlNakV0TlRFM015MDBPREEwTFRnMVpUZ3RNbVU0WWprek5tUTJObVl3TUlJQklqQU5CZ2txaGtpRzl3MEIKQVFFRkFBT0NBUThBTUlJQkNnS0NBUUVBdmFJYnhqak1HMlgzd2pEN05IRGVMRjY2SGRnMWlYT2syZVNLRjRFdgpwdDZiWlZxOHJyenhaMVprWkEvRXAyVXBFakdxeEhEZy9sSlM3S25mblpHNjRBRW10czlzWlNLVnZyTm5qUzc0Cld3K1NNZUtiS1ZpeHhjZzN4S1N5dSs5TUF0K0pneEkxZ0Q3SS9MS0puTm1VODU1MHczd3VEYTIxQi9leDlhUmgKdGxmcEp6dmNOYTVMcGMyUllPQUNvUC9hcTg2a3BwR0wvZUNQR2cvMFNrbHArblZ3bWNmbHhjMzZwZElNby9YcwpZNjVsWUlERWFSM2xKTkpKN1RDanBaN2diaGg2bXFJK0lJRXZwQlBhVWlDRmUxTzlWdmJBZHd2Q1g2LzExSy9oCitqQlhyMGplNW0wNWVBYTJkcEVLZ3p4b1plSURzUHI0WmJmV0x1WCtCSm90WXdJREFRQUJveU13SVRBT0JnTlYKSFE4QkFmOEVCQU1DQWdRd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBTkJna3Foa2lHOXcwQkFRc0ZBQU9DQVFFQQpQWWx0Q1M4andBcDFNK1h1UzBBZXQ3SnRUalkrVlIveVVTUGNQeTVnMTZEaDRwMkhJSEp4cWE4ZjRzK2NmQUlOClVGRlVlN2VseFpoZjNBSVlCVStsNzFHRUlWNG5XWk5KZDFEd3QwbXRKUU1oTkduZ0JrQjFxTTBENDFSS2grQXcKRVgzek1XQTRmeFQ4d05oeU52OWYyblZxYSs1bGF1L0ViNFhuZUNWUHBHR255YTJVYWVxZzNnbzBvdnlSWWhTKwo3M1NGc1hvOGlnRmFFOTZiL2RpSnVJS3lsT01lSm9aVkUrZG1sYTF0aUxJT0FFZGEzVVZoSVp0ckY2ZVc2QVVFCmdtbGZ4bWVDS1ZrQzVhWitmdmxmQUJKTTBvSVl5NkhZUUkzVHp2WnQwQWx1cjc2Z2c0akJWS2cvR3l4aEdSeWQKODh1NEp6bndUU1FBZTI4VGJJbUZPZz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
      service:
        name: mutateme
        namespace: default
        path: "/mutate"
    rules:
      - operations: ["CREATE"]
        apiGroups: [""]
        apiVersions: ["v1"]
        resources: ["secrets"]
      - operations: ["UPDATE"]
        apiGroups: [""]
        apiVersions: ["v1"]
        resources: ["secrets"]
    namespaceSelector:
      matchLabels:
        mutateme: enabled
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: kubesecman
  namespace: default
  annotations:
    iam.gke.io/gcp-service-account: kubesecman@playground-marty-kuentzel.iam.gserviceaccount.com